// + ДБ Французова 08.09.2022  829
&НаСервере
Функция УдалитьПовторыМассива(Массив)
	МассивНовый = Новый Массив;
	Для каждого эл из Массив Цикл
		Если НЕ ЗначениеЗаполнено(эл) Тогда
			Продолжить;
		КонецЕсли;
		
		Если МассивНовый.Найти(эл.ПолноеНаименование())=Неопределено Тогда
			МассивНовый.Добавить(эл.ПолноеНаименование());
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат МассивНовый;
КонецФункции

// - ДБ Французова 08.09.2022  829
// + ДБ Французова 07.09.2022  829
&НаСервере
Процедура ПолучитьДанныеСотрудника(Структура)
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|Сотрудники.Ссылка КАК Сотрудник
	|ПОМЕСТИТЬ ВТ_Сотрудники_
	|ИЗ Справочник.Сотрудники КАК Сотрудники
	|ГДЕ Сотрудники.ФизическоеЛицо = &Сотр
	|;
	|
	|ВЫБРАТЬ
	|Рег.Сотрудник,
	|Рег.Сотрудник.ФизическоеЛицо КАК ФизическоеЛицо,
	|РАЗНОСТЬДАТ(Рег.Сотрудник.ФизическоеЛицо.ДатаРождения,&ПериодОтчета, ГОД) КАК Возраст
	|ПОМЕСТИТЬ КадрДолжность
	|ИЗ РегистрСведений.ТекущиеКадровыеДанныеСотрудников КАК Рег
	|//ГДЕ Рег.ТекущаяДолжность  = &Должность
	|//И РАЗНОСТЬДАТ(Рег.Сотрудник.ФизическоеЛицо.ДатаРождения,&ПериодОтчета, ГОД) > 40
	|ГДЕ Рег.Сотрудник В (ВЫБРАТЬ ВТ_Сотрудники_.Сотрудник ИЗ ВТ_Сотрудники_ КАК ВТ_Сотрудники_)
	|
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|КИ.Ссылка КАК ФизическоеЛицо,
	|КИ.Представление  КАК Адрес
	|ПОМЕСТИТЬ АдресаТ
	|ИЗ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КИ
	|ГДЕ КИ.Ссылка В (ВЫБРАТЬ КадрДолжность.ФизическоеЛицо ИЗ КадрДолжность  КАК КадрДолжность)
	|И КИ.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)
	|
	|;
	|ВЫБРАТЬ
	|КадрДолжность.Сотрудник КАК Ссылка,
	|КадрДолжность.Возраст ,
	|Адреса.Адрес
	|ПОМЕСТИТЬ ВТ_Сотрудники
	|ИЗ  КадрДолжность КАК КадрДолжность
	|ПРАВОЕ СОЕДИНЕНИЕ АдресаТ КАК Адреса ПО  КадрДолжность.ФизическоеЛицо = Адреса.ФизическоеЛицо
	|//ГДЕ Адреса.Адрес ПОДОБНО &Питер
	|;
	|ВЫБРАТЬ 
	|Рег.Сотрудник,
	|MAX(Рег.Период)
	|ПОМЕСТИТЬ ПоследнийСтатус
	|ИЗ РегистрСведений.СостоянияСотрудников.СрезПоследних КАК Рег
	|ГДЕ Рег.Сотрудник В (ВЫБРАТЬ ВТ_Сотрудники.Ссылка ИЗ ВТ_Сотрудники КАК ВТ_Сотрудники)
	|СГРУППИРОВАТЬ ПО
	|Рег.Сотрудник
	|;
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|Рег.Период,
	|РЕг.Регистратор,
	|Рег.Сотрудник, 
	|Рег.Подразделение КАК ПодразделениеОрганизации,
	|ПодразделениеТип.Ссылка КАК Подразделение,
	|Рег.Должность,
	|Рег.ФизическоеЛицо,
	|ДанныеПредыдущие.Должность КАК ПредыдущаяДолжность,
	|ДанныеПредыдущие.Период
	|ПОМЕСТИТЬ ДолжностьСотрудника
	|ИЗ РегистрСведений.КадроваяИсторияСотрудников КАК Рег
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КадроваяИсторияСотрудников КАК ДанныеПредыдущие
	|ПО Рег.Сотрудник = ДанныеПредыдущие.Сотрудник
	|И (ДанныеПредыдущие.Период В
	|(ВЫБРАТЬ ПЕРВЫЕ 1
	|ДанныеУсловие.Период
	|ИЗ
	|РегистрСведений.КадроваяИсторияСотрудников КАК ДанныеУсловие
	|ГДЕ
	|ДанныеУсловие.Сотрудник = Рег.Сотрудник
	|И ДанныеУсловие.Период < Рег.Период
	|УПОРЯДОЧИТЬ ПО
	|ДанныеУсловие.Период УБЫВ))
	|ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СтруктураПредприятия КАК ПодразделениеТип ПО ПодразделениеТип.Источник = Рег.Подразделение
	|ГДЕ Рег.Сотрудник В (ВЫБРАТЬ ПоследнийСтатус.Сотрудник ИЗ ПоследнийСтатус КАК ПоследнийСтатус)
	|;
	|ВЫБРАТЬ
	|КИ.Ссылка,
	|КИ.Город ,
	|КИ.Представление
	|ПОМЕСТИТЬ Адреса
	|ИЗ Справочник.ФизическиеЛица.КонтактнаяИнформация КАК КИ
	|ГДЕ КИ.Ссылка В (ВЫБРАТЬ ДолжностьСотрудника.ФизическоеЛицо ИЗ ДолжностьСотрудника  КАК ДолжностьСотрудника)
	|;
	|ВЫБРАТЬ  
	|РегЗапись.Период,
	|РегЗапись.Сотрудник,  
	|ВТ_Сотрудники.Возраст,
	|ВТ_Сотрудники.Адрес,
	|РегЗапись.Состояние,
	|РегЗапись.ДействуетДо,
	|ДолжностьСотрудника.Период,
	|ДолжностьСотрудника.Должность,
	|ДолжностьСотрудника.Подразделение,
	|ДолжностьСотрудника.Регистратор
	|//ПОМЕСТИТЬ РабочееСостояние
	|ИЗ РегистрСведений.СостоянияСотрудников КАК РегЗапись
	|ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПоследнийСтатус КАК ПоследнийСтатус
	|ПО ПоследнийСтатус.Сотрудник = РегЗапись.Сотрудник И ПоследнийСтатус.Период = РегЗапись.Период
	|ЛЕВОЕ СОЕДИНЕНИЕ ДолжностьСотрудника КАК ДолжностьСотрудника
	|ПО ДолжностьСотрудника.Сотрудник = РегЗапись.Сотрудник 
	|И (ДолжностьСотрудника.Период  В
	|( ВЫБРАТЬ ПЕРВЫЕ 1
	|ДолжностьСотрудникаРег.Период
	|ИЗ ДолжностьСотрудника КАК ДолжностьСотрудникаРег
	|ГДЕ ДолжностьСотрудникаРег.Сотрудник = РегЗапись.Сотрудник
	|
	|УПОРЯДОЧИТЬ ПО  ДолжностьСотрудникаРег.Период УБЫВ))
	|ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Сотрудники КАК ВТ_Сотрудники ПО ВТ_Сотрудники.Ссылка = РегЗапись.Сотрудник            
	|ГДЕ Не РегЗапись.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияСотрудника.Увольнение)
	|И РегЗапись.Сотрудник В (ВЫБРАТЬ ПоследнийСтатус.Сотрудник ИЗ ПоследнийСтатус КАК ПоследнийСтатус)
	|УПОРЯДОЧИТЬ ПО
	|РегЗапись.Сотрудник.Наименование ВОЗР   
	|";
	Запрос.УстановитьПараметр("Сотр",Структура.ПодотчетноеЛицо);
	Запрос.УстановитьПараметр("ПериодОтчета",Структура.ПериодОтчета);
	Результат = Запрос.Выполнить().Выгрузить();
	
	Для каждого стр из Результат Цикл
		СК = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(стр);
		Если ЗначениеЗаполнено(СК.Подразделение) Тогда
			Для каждого стрСК ИЗ СК Цикл
				Структура.Вставить(стрСК.Ключ,стрСК.Значение);
			КонецЦикла;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	МассивПодразделений = УдалитьПовторыМассива(Результат.ВыгрузитьКолонку("Подразделение"));
	Структура.Вставить("МассивПодразделений",МассивПодразделений);
	Если Структура.Свойство("Подразделение") Тогда
		ЗаполнитьЗначенияСвойств(Объект,Структура);
	КонецЕсли;
КонецПроцедуры

// - ДБ Французова 07.09.2022  829
// + ДБ Французова 07.09.2022  829
&НаКлиенте
Процедура ДБ_ПодотчетноеЛицоПриИзмененииПосле(Элемент)
	Сообщение = Новый СообщениеПользователю;
	Структура = Новый Структура;
	Если ЗначениеЗаполнено(Объект.ПодотчетноеЛицо) Тогда
		Структура.Вставить("ПодотчетноеЛицо",Объект.ПодотчетноеЛицо);
		Структура.Вставить("ПериодОтчета",Объект.Дата);
		ПолучитьДанныеСотрудника(Структура);
		Если Структура.МассивПодразделений.Количество()>1 Тогда
			ТекстСообщения = "Внимание: Подотчетное лицо числится на нескольких подразделениях: ";
			Для каждого эл из Структура.МассивПодразделений Цикл
				ТекстСообщения = ТекстСообщения +"
				|" + Строка(эл);
			КонецЦикла;
			Сообщение.Текст = ТекстСообщения;
			Сообщение.Сообщить();
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры
// - ДБ Французова 07.09.2022  829
