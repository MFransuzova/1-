// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Функция ГАС_ДокументПроверен()
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СтатусыПроверкиДокументов.СтатусПроверки = ЗНАЧЕНИЕ(Перечисление.ЭтапыПроверкиДокументаВРеглУчете.Проверен) КАК ДокументПроверен,
	|	СтатусыПроверкиДокументов.ДатаПроверки
	|ИЗ
	|	РегистрСведений.СтатусыПроверкиДокументов КАК СтатусыПроверкиДокументов
	|ГДЕ
	|	СтатусыПроверкиДокументов.Документ = &Документ
	|";
	Запрос.УстановитьПараметр("Документ", Объект.Ссылка);
	Результат = Запрос.Выполнить().Выгрузить();
	Если НЕ Результат.Количество()=0 Тогда
		Возврат  Результат[0].ДокументПроверен;
	Иначе
		Возврат Ложь;
	КонецЕсли;
КонецФункции
			   
&НаКлиенте
Процедура СоздатьПартииТМЦВыполнить(Команда)
	//Сообщение.Текст = "Привет";
	//Сообщение.Сообщить();
	//Возврат;
	Если ГАС_ДокументПроверен() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Документ проверен";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	Структура = Новый Структура;
	
	МассивСтрок = Новый Массив;   
	Владелец = ЭтаФорма.ВладелецФормы ;      
	Структура.Вставить("ВыделенныеСтроки",Элементы.Товары.ВыделенныеСтроки);   // Владелец.Элементы.Товары.ВыделенныеСтроки
	Для каждого индекс ИЗ  Структура.ВыделенныеСтроки Цикл
		СтруктураЗначений = ПолучитьСтруктуруСтроки();
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Элементы.Товары.ДанныеСтроки(индекс)); // Владелец.Элементы.Товары.ДанныеСтроки(индекс
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Объект);     // Владелец.Объект
		СтруктураЗначений.Вставить("индекс_строки",индекс);
		МассивСтрок.Добавить(СтруктураЗначений);
		//Структура.Вставить("СтруктураЗначений",СтруктураЗначений);
	КонецЦикла;
	
	Если МассивСтрок.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
	Структура.Вставить("МассивСтрок", МассивСтрок);
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Структура",Структура);
	// Выводим форму для заплнения Статьи затрат и Направленния деятельности
	ОткрытьФорму("Документ.ПеремещениеВЭксплуатации.Форма.ГАС_UPD_ВводПараметовУчета",СтруктураПараметров,ЭтаФорма,,,,Новый ОписаниеОповещения("ПолучитьВходныеПараметры", ЭтаФорма),РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	
	//Закрыть();
	//ОбщегоНазначенияКлиент.УстановитьКомпонентуИзМакета(Структура,Структура);
	
КонецПроцедуры
// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
// ГАС MF HD № 000090301 05.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

&НаКлиенте
Процедура ГАС_UPD_ТоварыПриОкончанииРедактированияПосле(Элемент, НоваяСтрока, ОтменаРедактирования)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;

	СтруктураЗаполенения = Новый Структура;
	Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.ПартияТМЦВЭксплуатацииСтарая) Тогда
		 СтруктураЗаполенения.Вставить("ПартияТМЦВЭксплуатацииСтарая",ТекущаяСтрока.ПартияТМЦВЭксплуатации);
		// ВернутьЗначенияОбъекта(СтруктураЗаполенения);
		 ЗаполнитьЗначенияСвойств(ТекущаяСтрока,СтруктураЗаполенения);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьВходныеПараметры(Структура,ДополнительныеПараметры)  Экспорт
	Если НЕ Структура.Свойство("УжеБыли") Тогда
		Структура.Вставить("УжеБыли",Истина); // по какой то причине дублируется вызов процедуры
	Иначе
		Возврат;
	КонецЕсли;
	Сообщение = Новый СообщениеПользователю;
	СоздатьПартии(Структура);
	Если Структура.Свойство("МассивСозданных") Тогда
		Для каждого эл из Структура.МассивСозданных Цикл
			ТекСтрока = Элементы.Товары.ДанныеСтроки(эл.индекс_строки);
		    СтараяПартия = ТекСтрока.ПартияТМЦВЭксплуатации; 
			эл.Вставить("ПартияТМЦВЭксплуатацииСтарая",СтараяПартия); 
			ЗаполнитьЗначенияСвойств(ТекСтрока,эл);    // Владелец.Элементы.Товары.ДанныеСтроки(эл.индекс_строки),эл
			Сообщение.Текст  = "Создана партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	Если Структура.Свойство("МассивИмеющихся") Тогда
		Для каждого эл из Структура.МассивИмеющихся Цикл
			ТекСтрока = Элементы.Товары.ДанныеСтроки(эл.индекс_строки);
		    СтараяПартия = ТекСтрока.ПартияТМЦВЭксплуатации; 
			эл.Вставить("ПартияТМЦВЭксплуатацииСтарая",СтараяПартия); 
	        ЗаполнитьЗначенияСвойств(ТекСтрока,эл); 
			Сообщение.Текст  = "Уже существует партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГАС_UPD_ОбработкаОповещенияПосле(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ПолучитьВходныеПараметры" Тогда
		ДополнительныеПараметры = Новый	Структура;
		ПолучитьВходныеПараметры(Параметр,ДополнительныеПараметры);
	КонецЕсли;
	
КонецПроцедуры
// ГАС MF HD № 000090301 05.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
