
// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&После("ПриСозданииНаСервере")
&НаСервере
Процедура ГАС_ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если НЕ ЭтаФорма.Команды.Найти("ГАС_СоздатьПартииТМЦ_Светка") =  Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Команда_ГАС_СоздатьПартию                       = ЭтаФорма.Команды.Добавить("ГАС_СоздатьПартииТМЦ_Светка");
	Команда_ГАС_СоздатьПартию.Действие              = "СоздатьПартииТМЦВыполнить";
	
	Кнопка_ГАС_СоздатьПартию                        = Элементы.Добавить("Кнопка_ГАС_СоздатьПартию", Тип("КнопкаФормы"), Элементы.ТоварыГруппа);
	Кнопка_ГАС_СоздатьПартию.Вид                    = ВидКнопкиФормы.ОбычнаяКнопка;
	Кнопка_ГАС_СоздатьПартию.ИмяКоманды             = "ГАС_СоздатьПартииТМЦ_Светка";
	Кнопка_ГАС_СоздатьПартию.Заголовок              = "(ГАС) Создать партию";
	
	Элементы.Товары.ПодчиненныеЭлементы.ТоварыПартияТМЦВЭксплуатацииСтарая.Заголовок = "Партия до изменения";
	// + ГАС MF HD № 000090301 16.08.21 (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
	Кнопка_ГАС_СоздатьПартию.Доступность = НЕ ГАС_ДокументПроверен();
	// - ГАС MF HD № 000090301 16.08.21 (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
КонецПроцедуры

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Функция ПолучитьСтруктуруНовыхПартий()
	Структура = Новый Структура;
	Справ_партии  = Метаданные.Справочники.ПартииТМЦВЭксплуатации.Реквизиты;
	Для каждого эл из   Справ_партии Цикл
		Структура.Вставить(эл.Имя,Неопределено);
	КонецЦикла;
	Структура.Вставить("Наименование",Неопределено);

	Возврат Структура;
КонецФункции

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Процедура СоздатьЭлементыПартий(СтруктураОбработки)
	УстановитьПривилегированныйРежим(Истина);
	МассивСозданных = Новый Массив;
	МассивИмеющихся = Новый Массив;
	Для каждого эл из СтруктураОбработки.МассивНовых Цикл
		ЗаполнитьЗначенияСвойств(эл,СтруктураОбработки);
		Запрос = Новый Запрос;
		Запрос.Текст = "
		|ВЫБРАТЬ
		|Партии.Ссылка
		|ИЗ Справочник.ПартииТМЦВЭксплуатации КАК Партии
		|ГДЕ  Партии.ФизическоеЛицо = &ФЛ И  Партии.НаправлениеДеятельности = &НД 
		|И Партии.СтатьяРасходов = &СР И Партии.АналитикаРасходов =  &АР И Партии.Наименование =  &ИмяПартии
		|";
		Запрос.УстановитьПараметр("ФЛ",эл.ФизическоеЛицо);
		Запрос.УстановитьПараметр("НД",эл.НаправлениеДеятельности);
		Запрос.УстановитьПараметр("СР",эл.СтатьяРасходов);
		Запрос.УстановитьПараметр("АР",эл.АналитикаРасходов);
		Запрос.УстановитьПараметр("ИмяПартии",эл.Наименование);
		
		Результат = Запрос.Выполнить().Выгрузить();
		Если НЕ Результат.Количество() = 0 Тогда
			Для каждого Партия из Результат Цикл
				СтруктураНового = Новый Структура;
				СтруктураНового.Вставить("ПартияТМЦВЭксплуатации",Партия.Ссылка);
				СтруктураНового.Вставить("индекс_строки",эл.индекс_строки);
				МассивИмеющихся.Добавить(СтруктураНового);
			КонецЦикла;
			
			Продолжить;
		КонецЕсли;
		НоваяПартия = Справочники.ПартииТМЦВЭксплуатации.СоздатьЭлемент();
		//эл.АналитикаРасходов = Объект.ПодразделениеПолучатель ;
		ЗаполнитьЗначенияСвойств(НоваяПартия,эл);
		НоваяПартия.УстановитьНовыйКод();
		НоваяПартия.Записать();
		СтруктураНового = Новый Структура;
		СтруктураНового.Вставить("ПартияТМЦВЭксплуатации",НоваяПартия.Ссылка);
		СтруктураНового.Вставить("индекс_строки",эл.индекс_строки);
		МассивСозданных.Добавить(СтруктураНового);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивСозданных",МассивСозданных);
	СтруктураОбработки.Вставить("МассивИмеющихся",МассивИмеющихся);

	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Процедура СоздатьПартии(СтруктураОбработки)
	Сообщение = Новый СообщениеПользователю;
	Если НЕ СтруктураОбработки.Свойство("МассивСтрок") Тогда
		Сообщение.Текст = "Не выделены строки";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	МассивНовых = Новый Массив;
	
	Для каждого элПартия ИЗ СтруктураОбработки.МассивСтрок Цикл 
		СтруктураНовых = ПолучитьСтруктуруНовыхПартий();
		ЗаполнитьЗначенияСвойств(СтруктураНовых,элПартия.ПартияТМЦВЭксплуатации);
		СтруктураНовых.СтатьяРасходов = СтруктураОбработки.СтатьяРасходов;     
		СтруктураНовых.НаправлениеДеятельности = СтруктураОбработки.НаправлениеДеятельности;   
 		СтруктураНовых.АналитикаРасходов = Объект.ПодразделениеПолучатель;   
      
		СтруктураНовых.Вставить("индекс_строки",элПартия.индекс_строки);
		МассивНовых.Добавить(СтруктураНовых);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивНовых",МассивНовых);
	Если НЕ СтруктураОбработки.МассивНовых.Количество()=0 Тогда
		СоздатьЭлементыПартий(СтруктураОбработки);
	КонецЕсли;
	
	//Общегоназначения.УстановитьСвойстваДинамическогоСписка(СтруктураОбработки,СтруктураОбработки);
КонецПроцедуры

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Функция ПолучитьСтруктуруСтроки()
	
	СтруктураСтроки = Новый Структура;
	МассивКолонок = Новый Массив;
	МассивКолонок.Добавить("Номенклатура");
	МассивКолонок.Добавить("Характеристика");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатации");
	МассивКолонок.Добавить("Количество");
	МассивКолонок.Добавить("ФизическоеЛицо");
	МассивКолонок.Добавить("ФизическоеЛицоПолучатель");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатацииСтарая");   // нужно добавить реквизит
	МассивКолонок.Добавить("Организация");
	МассивКолонок.Добавить("Подразделение");
	МассивКолонок.Добавить("ПодразделениеПолучатель");
	
	Для каждого эл из МассивКолонок Цикл
		СтруктураСтроки.Вставить(эл,Неопределено);
	КонецЦикла;
	
	Возврат СтруктураСтроки;
КонецФункции

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&После("ПриОткрытии")
&НаКлиенте
Процедура ГАС_ПриОткрытии(Отказ)
КонецПроцедуры

// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

// ГАС MF HD № 000090301 04.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
&НаСервере
Функция ГАС_ДокументПроверен()
	Если НЕ ЗначениеЗаполнено(Объект.Ссылка) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СтатусыПроверкиДокументов.СтатусПроверки = ЗНАЧЕНИЕ(Перечисление.ЭтапыПроверкиДокументаВРеглУчете.Проверен) КАК ДокументПроверен,
	|	СтатусыПроверкиДокументов.ДатаПроверки
	|ИЗ
	|	РегистрСведений.СтатусыПроверкиДокументов КАК СтатусыПроверкиДокументов
	|ГДЕ
	|	СтатусыПроверкиДокументов.Документ = &Документ
	|";
	Запрос.УстановитьПараметр("Документ", Объект.Ссылка);
	Результат = Запрос.Выполнить().Выгрузить();
	Если НЕ Результат.Количество()=0 Тогда
		Возврат  Результат[0].ДокументПроверен;
	Иначе
		Возврат Ложь;
	КонецЕсли;
КонецФункции
			   
&НаКлиенте
Процедура СоздатьПартииТМЦВыполнить(Команда)
	//Сообщение.Текст = "Привет";
	//Сообщение.Сообщить();
	//Возврат;
	Если ГАС_ДокументПроверен() Тогда
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Документ проверен";
		Сообщение.Сообщить();
		Возврат;
	КонецЕсли;
	
	Структура = Новый Структура;
	
	МассивСтрок = Новый Массив;   
	Владелец = ЭтаФорма.ВладелецФормы ;      
	Структура.Вставить("ВыделенныеСтроки",Элементы.Товары.ВыделенныеСтроки);   // Владелец.Элементы.Товары.ВыделенныеСтроки
	Для каждого индекс ИЗ  Структура.ВыделенныеСтроки Цикл
		СтруктураЗначений = ПолучитьСтруктуруСтроки();
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Элементы.Товары.ДанныеСтроки(индекс)); // Владелец.Элементы.Товары.ДанныеСтроки(индекс
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Объект);     // Владелец.Объект
		СтруктураЗначений.Вставить("индекс_строки",индекс);
		МассивСтрок.Добавить(СтруктураЗначений);
		//Структура.Вставить("СтруктураЗначений",СтруктураЗначений);
	КонецЦикла;
	
	Если МассивСтрок.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
	Структура.Вставить("МассивСтрок", МассивСтрок);
	СтруктураПараметров = Новый Структура;
	СтруктураПараметров.Вставить("Структура",Структура);
	// Выводим форму для заплнения Статьи затрат и Направленния деятельности
	ОткрытьФорму("Документ.ПеремещениеВЭксплуатации.Форма.ГАС_UPD_ВводПараметовУчета",СтруктураПараметров,ЭтаФорма,,,,Новый ОписаниеОповещения("ПолучитьВходныеПараметры", ЭтаФорма),РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
	
	//Закрыть();
	//ОбщегоНазначенияКлиент.УстановитьКомпонентуИзМакета(Структура,Структура);
	
КонецПроцедуры
// ГАС MF HD № 000090301 04.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
// ГАС MF HD № 000090301 05.08.21 начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

&НаКлиенте
Процедура ГАС_UPD_ТоварыПриОкончанииРедактированияПосле(Элемент, НоваяСтрока, ОтменаРедактирования)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;

	СтруктураЗаполенения = Новый Структура;
	Если НЕ ЗначениеЗаполнено(ТекущаяСтрока.ПартияТМЦВЭксплуатацииСтарая) Тогда
		 СтруктураЗаполенения.Вставить("ПартияТМЦВЭксплуатацииСтарая",ТекущаяСтрока.ПартияТМЦВЭксплуатации);
		// ВернутьЗначенияОбъекта(СтруктураЗаполенения);
		 ЗаполнитьЗначенияСвойств(ТекущаяСтрока,СтруктураЗаполенения);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьВходныеПараметры(Структура,ДополнительныеПараметры)  Экспорт
	Если НЕ Структура.Свойство("УжеБыли") Тогда
		Структура.Вставить("УжеБыли",Истина); // по какой то причине дублируется вызов процедуры
	Иначе
		Возврат;
	КонецЕсли;
	Сообщение = Новый СообщениеПользователю;
	СоздатьПартии(Структура);
	Если Структура.Свойство("МассивСозданных") Тогда
		Для каждого эл из Структура.МассивСозданных Цикл
			ТекСтрока = Элементы.Товары.ДанныеСтроки(эл.индекс_строки);
		    СтараяПартия = ТекСтрока.ПартияТМЦВЭксплуатации; 
			эл.Вставить("ПартияТМЦВЭксплуатацииСтарая",СтараяПартия); 
			ЗаполнитьЗначенияСвойств(ТекСтрока,эл);    // Владелец.Элементы.Товары.ДанныеСтроки(эл.индекс_строки),эл
			Сообщение.Текст  = "Создана партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	Если Структура.Свойство("МассивИмеющихся") Тогда
		Для каждого эл из Структура.МассивИмеющихся Цикл
			ТекСтрока = Элементы.Товары.ДанныеСтроки(эл.индекс_строки);
		    СтараяПартия = ТекСтрока.ПартияТМЦВЭксплуатации; 
			эл.Вставить("ПартияТМЦВЭксплуатацииСтарая",СтараяПартия); 
	        ЗаполнитьЗначенияСвойств(ТекСтрока,эл); 
			Сообщение.Текст  = "Уже существует партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГАС_UPD_ОбработкаОповещенияПосле(ИмяСобытия, Параметр, Источник)
	Если ИмяСобытия = "ПолучитьВходныеПараметры" Тогда
		ДополнительныеПараметры = Новый	Структура;
		ПолучитьВходныеПараметры(Параметр,ДополнительныеПараметры);
	КонецЕсли;
	
КонецПроцедуры
// ГАС MF HD № 000090301 05.08.21 окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)

Форма 2

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    //ГАС MF HD № 000090301 06.08.21   начало (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
	Группа_ГАС_Учета                                = Элементы.Добавить("ГруппаУчета", Тип("ГруппаФормы"), ЭтаФорма);
	Группа_ГАС_Учета.Вид                            = ВидГруппыФормы.ОбычнаяГруппа;                                             
	Группа_ГАС_Учета.Группировка                    = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	Группа_ГАС_Учета.ГоризонтальноеПоложениеВГруппе = ГоризонтальноеПоложениеЭлемента.Право;
	Группа_ГАС_Учета.ВертикальноеПоложениеВГруппе   = ВертикальноеПоложениеЭлемента.Верх;
	Группа_ГАС_Учета.ОтображатьЗаголовок            = Ложь;
	
	Поле_ГАС_СтатьяРасходов                         = Элементы.Добавить("СтатьяРасходов", Тип("ПолеФормы"), Элементы.ГруппаУчета);
	Поле_ГАС_СтатьяРасходов.Вид                     = ВидПоляФормы.ПолеВвода;    
	Поле_ГАС_СтатьяРасходов.Заголовок               = "Статья расходов";
	Поле_ГАС_СтатьяРасходов.ПутьКДанным             = "СтатьяРасходов";
	
	Поле_ГАС_НаправлениеДеятельности                = Элементы.Добавить("НаправлениеДеятельности", Тип("ПолеФормы"), Элементы.ГруппаУчета);
	Поле_ГАС_НаправлениеДеятельности.Вид            = ВидПоляФормы.ПолеВвода;
	Поле_ГАС_НаправлениеДеятельности.Заголовок      = "Направление деятельности";
	Поле_ГАС_НаправлениеДеятельности.ПутьКДанным    = "НаправлениеДеятельности";
	
	Команда_ГАС_СоздатьПартию                       = ЭтаФорма.Команды.Добавить("ГАС_СоздатьПартииТМЦ_Светка");
	Команда_ГАС_СоздатьПартию.Действие              = "ВернутьЗначенияПартииТМЦВыполнить";
	
	Кнопка_ГАС_СоздатьПартию                        = Элементы.Добавить("Кнопка_ГАС_СоздатьПартию", Тип("КнопкаФормы"),  Элементы.ГруппаУчета);
	Кнопка_ГАС_СоздатьПартию.Вид                    = ВидКнопкиФормы.ОбычнаяКнопка;
	Кнопка_ГАС_СоздатьПартию.ИмяКоманды             = "ГАС_СоздатьПартииТМЦ_Светка";
	Кнопка_ГАС_СоздатьПартию.Заголовок              = "Выполнить";
	Кнопка_ГАС_СоздатьПартию.ЦветФона               = Новый Цвет(255, 255, 0);
	ПараметрыВходящие = Параметры.Структура;
    //ГАС MF HD № 000090301 06.08.21   окончание (Доработка функционала : дополнение возможности создания новых партий док.ПеремещениеВЭксплуатацию)
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьЗначенияДляОбработки(ПараметрыВходящие)
	ПараметрыВходящие.Вставить("НаправлениеДеятельности",НаправлениеДеятельности);
	ПараметрыВходящие.Вставить("СтатьяРасходов",СтатьяРасходов);
КонецПроцедуры

&НаКлиенте
Процедура ВернутьЗначенияПартииТМЦВыполнить(Команда)
	ЗаполнитьЗначенияДляОбработки(ПараметрыВходящие);
	Оповестить("ПолучитьВходныеПараметры",ПараметрыВходящие);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	//ЭтаФорма.Высота = 100;
	//ЭтаФорма.Ширина = 100;
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)  
	Закрыть(Параметр);
	// Вставить содержимое обработчика.
КонецПроцедуры


