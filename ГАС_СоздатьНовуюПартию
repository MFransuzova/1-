
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
КонецПроцедуры
&НаСервере
Функция ПолучитьСтруктуруНовыхПартий()
	Структура = Новый Структура;
	Справ_партии  = Метаданные.Справочники.ПартииТМЦВЭксплуатации.Реквизиты;
	Для каждого эл из   Справ_партии Цикл
		Структура.Вставить(эл.Имя,Неопределено);
	КонецЦикла;
	Возврат Структура;
КонецФункции

&НаСервере
Процедура СоздатьЭлементыПартий(СтруктураОбработки)
	УстановитьПривилегированныйРежим(Истина);
	МассивСозданных = Новый Массив;
	МассивИмеющихся = Новый Массив;
	Для каждого эл из СтруктураОбработки.МассивНовых Цикл
		Запрос = Новый Запрос;
		Запрос.Текст = "
		|ВЫБРАТЬ
		|Партии.Ссылка
		|ИЗ Справочник.ПартииТМЦВЭксплуатации КАК Партии
		|ГДЕ  Партии.ФизическоеЛицо = &ФЛ И  Партии.НаправлениеДеятельности = &НД 
		|И Партии.СтатьяРасходов = &СР И Партии.АналитикаРасходов =  &АР
		|";
		Запрос.УстановитьПараметр("ФЛ",эл.ФизическоеЛицо);
		Запрос.УстановитьПараметр("НД",эл.НаправлениеДеятельности);
		Запрос.УстановитьПараметр("СР",эл.СтатьяРасходов);
		Запрос.УстановитьПараметр("АР",эл.АналитикаРасходов);
		Результат = Запрос.Выполнить().Выгрузить();
		Если НЕ Результат.Количество() = 0 Тогда
			Для каждого Партия из Результат Цикл
				МассивИмеющихся.Добавить(Партия.Ссылка);
			КонецЦикла;
			
			Продолжить;
		КонецЕсли;
		НоваяПартия = Справочники.ПартииТМЦВЭксплуатации.СоздатьЭлемент();
		ЗаполнитьЗначенияСвойств(НоваяПартия,эл);
		НоваяПартия.УстановитьНовыйКод();
		НоваяПартия.Записать();
		МассивСозданных.Добавить(НоваяПартия.Ссылка);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивСозданных",МассивСозданных);
	СтруктураОбработки.Вставить("МассивИмеющихся",МассивИмеющихся);

	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаСервере
Процедура СоздатьПартии(СтруктураОбработки)
	МассивНовых = Новый Массив;
	
	Для каждого элПартия ИЗ СтруктураОбработки.МассивСтрок Цикл 
		СтруктураНовых = ПолучитьСтруктуруНовыхПартий();
		ЗаполнитьЗначенияСвойств(СтруктураНовых,элПартия.ПартияТМЦВЭксплуатации);
		СтруктураНовых.СтатьяРасходов = Объект.СтатьяРасходов;
		СтруктураНовых.НаправлениеДеятельности = Объект.НаправлениеДеятельности;
		МассивНовых.Добавить(СтруктураНовых);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивНовых",МассивНовых);
	Если НЕ СтруктураОбработки.МассивНовых.Количество()=0 Тогда
		СоздатьЭлементыПартий(СтруктураОбработки);
	КонецЕсли;
	
	//Общегоназначения.УстановитьСвойстваДинамическогоСписка(СтруктураОбработки,СтруктураОбработки);
КонецПроцедуры

&НаСервере
Функция ПолучитьСтруктуруСтроки()
	
	СтруктураСтроки = Новый Структура;
	МассивКолонок = Новый Массив;
	МассивКолонок.Добавить("Номенклатура");
	МассивКолонок.Добавить("Характеристика");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатации");
	МассивКолонок.Добавить("Количество");
	МассивКолонок.Добавить("ФизическоеЛицо");
	МассивКолонок.Добавить("ФизическоеЛицоПолучатель");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатацииСтарая");
	МассивКолонок.Добавить("Организация");
	МассивКолонок.Добавить("Подразделение");
	МассивКолонок.Добавить("ПодразделениеПолучатель");
	
	Для каждого эл из МассивКолонок Цикл
		СтруктураСтроки.Вставить(эл,Неопределено);
	КонецЦикла;
	
	Возврат СтруктураСтроки;
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
КонецПроцедуры

&НаКлиенте
Процедура СоздатьПартииТМЦ(Команда)
	// Вставить содержимое обработчика
	Сообщение = Новый СообщениеПользователю;
	Структура = Новый Структура;
	
	МассивСтрок = Новый Массив;   
	Владелец = ЭтаФорма.ВладелецФормы ;      
	Структура.Вставить("ВыделенныеСтроки",Владелец.Элементы.Товары.ВыделенныеСтроки);
	Для каждого индекс ИЗ  Структура.ВыделенныеСтроки Цикл
		СтруктураЗначений = ПолучитьСтруктуруСтроки();
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Владелец.Элементы.Товары.ДанныеСтроки(индекс));
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Владелец.Объект);
		
		МассивСтрок.Добавить(СтруктураЗначений);
		Структура.Вставить("СтруктураЗначений",СтруктураЗначений);
	КонецЦикла;
	
	Структура.Вставить("МассивСтрок", МассивСтрок);
	СоздатьПартии(Структура);
	Если Структура.Свойство("МассивСозданных") Тогда
		Для каждого эл из Структура.МассивСозданных Цикл
			Сообщение.Текст  = "Создана партия: "+Строка(эл);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	Если Структура.Свойство("МассивИмеющихся") Тогда
		Для каждого эл из Структура.МассивИмеющихся Цикл
			Сообщение.Текст  = "Уже существует партия: "+Строка(эл);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	
	
	//ОбщегоНазначенияКлиент.УстановитьКомпонентуИзМакета(Структура,Структура);
	
КонецПроцедуры
