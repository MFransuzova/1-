
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
КонецПроцедуры
&НаСервере
Функция ПолучитьСтруктуруНовыхПартий()
	Структура = Новый Структура;
	Справ_партии  = Метаданные.Справочники.ПартииТМЦВЭксплуатации.Реквизиты;
	Для каждого эл из   Справ_партии Цикл
		Структура.Вставить(эл.Имя,Неопределено);
	КонецЦикла;
	Структура.Вставить("Наименование",Неопределено);

	Возврат Структура;
КонецФункции

&НаСервере
Процедура СоздатьЭлементыПартий(СтруктураОбработки)
	УстановитьПривилегированныйРежим(Истина);
	МассивСозданных = Новый Массив;
	МассивИмеющихся = Новый Массив;
	Для каждого эл из СтруктураОбработки.МассивНовых Цикл
		Запрос = Новый Запрос;
		Запрос.Текст = "
		|ВЫБРАТЬ
		|Партии.Ссылка
		|ИЗ Справочник.ПартииТМЦВЭксплуатации КАК Партии
		|ГДЕ  Партии.ФизическоеЛицо = &ФЛ И  Партии.НаправлениеДеятельности = &НД 
		|И Партии.СтатьяРасходов = &СР И Партии.АналитикаРасходов =  &АР И Партии.Наименование =  &ИмяПартии
		|";
		Запрос.УстановитьПараметр("ФЛ",эл.ФизическоеЛицо);
		Запрос.УстановитьПараметр("НД",эл.НаправлениеДеятельности);
		Запрос.УстановитьПараметр("СР",эл.СтатьяРасходов);
		Запрос.УстановитьПараметр("АР",эл.АналитикаРасходов);
		Запрос.УстановитьПараметр("ИмяПартии",эл.Наименование);
		
		Результат = Запрос.Выполнить().Выгрузить();
		Если НЕ Результат.Количество() = 0 Тогда
			Для каждого Партия из Результат Цикл
				СтруктураНового = Новый Структура;
				СтруктураНового.Вставить("ПартияТМЦВЭксплуатации",Партия.Ссылка);
				СтруктураНового.Вставить("индекс_строки",эл.индекс_строки);
				МассивИмеющихся.Добавить(СтруктураНового);
			КонецЦикла;
			
			Продолжить;
		КонецЕсли;
		НоваяПартия = Справочники.ПартииТМЦВЭксплуатации.СоздатьЭлемент();
		ЗаполнитьЗначенияСвойств(НоваяПартия,эл);
		НоваяПартия.УстановитьНовыйКод();
		НоваяПартия.Записать();
		СтруктураНового = Новый Структура;
		СтруктураНового.Вставить("ПартияТМЦВЭксплуатации",НоваяПартия.Ссылка);
		СтруктураНового.Вставить("индекс_строки",эл.индекс_строки);
		МассивСозданных.Добавить(СтруктураНового);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивСозданных",МассивСозданных);
	СтруктураОбработки.Вставить("МассивИмеющихся",МассивИмеющихся);

	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаСервере
Процедура СоздатьПартии(СтруктураОбработки)
	МассивНовых = Новый Массив;
	
	Для каждого элПартия ИЗ СтруктураОбработки.МассивСтрок Цикл 
		СтруктураНовых = ПолучитьСтруктуруНовыхПартий();
		ЗаполнитьЗначенияСвойств(СтруктураНовых,элПартия.ПартияТМЦВЭксплуатации);
		СтруктураНовых.СтатьяРасходов = Объект.СтатьяРасходов;
		СтруктураНовых.НаправлениеДеятельности = Объект.НаправлениеДеятельности;
		СтруктураНовых.Вставить("индекс_строки",элПартия.индекс_строки);
		МассивНовых.Добавить(СтруктураНовых);
	КонецЦикла;
	СтруктураОбработки.Вставить("МассивНовых",МассивНовых);
	Если НЕ СтруктураОбработки.МассивНовых.Количество()=0 Тогда
		СоздатьЭлементыПартий(СтруктураОбработки);
	КонецЕсли;
	
	//Общегоназначения.УстановитьСвойстваДинамическогоСписка(СтруктураОбработки,СтруктураОбработки);
КонецПроцедуры

&НаСервере
Функция ПолучитьСтруктуруСтроки()
	
	СтруктураСтроки = Новый Структура;
	МассивКолонок = Новый Массив;
	МассивКолонок.Добавить("Номенклатура");
	МассивКолонок.Добавить("Характеристика");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатации");
	МассивКолонок.Добавить("Количество");
	МассивКолонок.Добавить("ФизическоеЛицо");
	МассивКолонок.Добавить("ФизическоеЛицоПолучатель");
	МассивКолонок.Добавить("ПартияТМЦВЭксплуатацииСтарая");
	МассивКолонок.Добавить("Организация");
	МассивКолонок.Добавить("Подразделение");
	МассивКолонок.Добавить("ПодразделениеПолучатель");
	
	Для каждого эл из МассивКолонок Цикл
		СтруктураСтроки.Вставить(эл,Неопределено);
	КонецЦикла;
	
	Возврат СтруктураСтроки;
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
КонецПроцедуры

&НаКлиенте
Процедура СоздатьПартииТМЦ(Команда)
	// Вставить содержимое обработчика
	Сообщение = Новый СообщениеПользователю;
	Структура = Новый Структура;
	
	МассивСтрок = Новый Массив;   
	Владелец = ЭтаФорма.ВладелецФормы ;      
	Структура.Вставить("ВыделенныеСтроки",Владелец.Элементы.Товары.ВыделенныеСтроки);
	Для каждого индекс ИЗ  Структура.ВыделенныеСтроки Цикл
		СтруктураЗначений = ПолучитьСтруктуруСтроки();
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Владелец.Элементы.Товары.ДанныеСтроки(индекс));
		ЗаполнитьЗначенияСвойств(СтруктураЗначений,Владелец.Объект);
		СтруктураЗначений.Вставить("индекс_строки",индекс);
		МассивСтрок.Добавить(СтруктураЗначений);
		Структура.Вставить("СтруктураЗначений",СтруктураЗначений);
	КонецЦикла;
	
	Структура.Вставить("МассивСтрок", МассивСтрок);
	СоздатьПартии(Структура);
	Если Структура.Свойство("МассивСозданных") Тогда
		Для каждого эл из Структура.МассивСозданных Цикл
			ЗаполнитьЗначенияСвойств(Владелец.Элементы.Товары.ДанныеСтроки(эл.индекс_строки),эл);
			Сообщение.Текст  = "Создана партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	Если Структура.Свойство("МассивИмеющихся") Тогда
		Для каждого эл из Структура.МассивИмеющихся Цикл
			ЗаполнитьЗначенияСвойств(Владелец.Элементы.Товары.ДанныеСтроки(эл.индекс_строки),эл);
			Сообщение.Текст  = "Уже существует партия: "+Строка(эл.ПартияТМЦВЭксплуатации);
			Сообщение.Сообщить();
		КонецЦикла;
	КонецЕсли;
	
	Закрыть();
	//ОбщегоНазначенияКлиент.УстановитьКомпонентуИзМакета(Структура,Структура);
	
КонецПроцедуры
