 // + ДБ Французова 17.02.2023  ( 1144 документооборот )
 &НаСервере
Процедура ПолучитьДанныеДокумента(Структура)
	
	Если НЕ Структура.Свойство("ВнешнийОбъект") Тогда
		Возврат;
	КонецЕсли;
	
	ВнешнийОбъект = Структура.ВнешнийОбъект;
	ДоступенФункционалВизы = Истина;
    ДоступенФункционалРезолюции	= Истина;  
	
	Прокси = ИнтеграцияС1СДокументооборотБазоваяФункциональностьПовтИсп.ПолучитьПрокси();
	
	ВнешнийОбъектXDTO = ИнтеграцияС1СДокументооборотБазоваяФункциональность.СоздатьОбъект(Прокси, "ExternalObject");
	ВнешнийОбъектXDTO.ID = Строка(ВнешнийОбъект.УникальныйИдентификатор());
	ВнешнийОбъектXDTO.type = ВнешнийОбъект.Метаданные().ПолноеИмя();
	ВнешнийОбъектXDTO.name = Строка(ВнешнийОбъект);
	
	Запрос = ИнтеграцияС1СДокументооборотБазоваяФункциональность.СоздатьОбъект(Прокси, "DMGetDocumentListRequest");
	СписокВнешнихОбъектов = Запрос.externalObjects; // СписокXDTO
	ПолучаемыеПоля = Запрос.columnSet; // СписокXDTO
	
	СписокВнешнихОбъектов.Добавить(ВнешнийОбъектXDTO);
	
	ПолучаемыеПоля.Добавить("name");
	Если ДоступенФункционалВизы Тогда
		ПолучаемыеПоля.Добавить("visas");
	КонецЕсли;
	Если ДоступенФункционалРезолюции Тогда
		ПолучаемыеПоля.Добавить("resolutions");
	КонецЕсли;
	
	Результат = Прокси.execute(Запрос);
	Если ИнтеграцияС1СДокументооборотБазоваяФункциональность.ПроверитьТип(Прокси, Результат, "DMError") Тогда 
		ВызватьИсключение Результат.description;
	КонецЕсли;
		
	ОбъектXDTO = Неопределено;
	Если ИнтеграцияС1СДокументооборотБазоваяФункциональность.ПроверитьТип(Прокси, Результат, "DMGetObjectListResponse") Тогда
		Если Результат.items.Количество() > 0 Тогда
			ОбъектXDTO = Результат.items[0].object;
		КонецЕсли;
	Иначе // совместимость со старыми версиями сервиса
		Если Результат.documents.Количество() > 0 Тогда
			ОбъектXDTO = Результат.documents[0];
		КонецЕсли;
	КонецЕсли;
	
		
	Если НЕ ОбъектXDTO = Неопределено Тогда
		// Заполним основные реквизиты.
		ДокументID = ОбъектXDTO.objectID.ID;
		ДокументТип = ОбъектXDTO.objectID.type;
		Документ = ОбъектXDTO.name;     // Здесь получаем нужный нам документ 
		Структура.Вставить("Документ",Документ);
	КонецЕсли;
	
КонецПроцедуры
// - ДБ Французова 17.02.2023   ( 1144 документооборот )
// + ДБ Французова 17.02.2023  ( 1144 документооборот )  
&НаСервере
Процедура ОбработкаДанных()
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ 
	|Рег.Объект
	|ИЗ РегистрСведений.ОбъектыИнтегрированныеС1СДокументооборотом КАК  Рег
	|ГДЕ Рег.Объект ССЫЛКА Документ.ПриобретениеУслугПрочихАктивов 
	| ИЛИ Рег.Объект ССЫЛКА Документ.ПриобретениеТоваровУслуг
	|";        
	//Запрос.УстановитьПараметр("Объект",);
	Результат = Запрос.Выполнить().Выгрузить();
	МассивОбъектов = Результат.ВыгрузитьКолонку("Объект");   
	МассивДанныхОтчета = Новый Массив;
	Для каждого эл из МассивОбъектов Цикл 
		Если эл = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураДанных = Новый Структура;
		СтруктураДанных.Вставить("ВнешнийОбъект",эл); 
		СтруктураДанных.Вставить("Документ",Неопределено);   
		ПолучитьДанныеДокумента(СтруктураДанных);

		Если НЕ СтруктураДанных.Документ = Неопределено Тогда 
			МассивДанныхОтчета.Добавить(СтруктураДанных);      
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура Команда1(Команда)
	ОбработкаДанных();
КонецПроцедуры

// - ДБ Французова 17.02.2023   ( 1144 документооборот )


