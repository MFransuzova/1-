// + АИГ Французова 21.02.2022 (Доработка)
#Область АИГ_Доработка
// + АИГ Французова 21.02.2022 (Доработка)
Функция ВернутьТекстЗапроса(СтруктураПараметровПечати) Экспорт
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|ФЛ.Ссылка
	|ПОМЕСТИТЬ ФЛ
	|ИЗ Справочник.ФизическиеЛица КАК Фл
	|ГДЕ	ФЛ.Ссылка = &ТекущаяСсылка
	|;
	|ВЫБРАТЬ
	|   ""ROW"" КАК ТипИзменения,
	|	Рег.Период КАК Дата,
	|	Рег.Row КАК КтоИзменял
	|ПОМЕСТИТЬ ROW
	|ИЗ
	|	РегистрСведений.КК_ИнформацияФизЛицRow КАК Рег
	|ГДЕ
	|  Рег.ФизЛицо В (ВЫБРАТЬ ФЛ.Ссылка ИЗ ФЛ КАК ФЛ)
	|;
	|ВЫБРАТЬ
	|   ""Function"" КАК ТипИзменения,
	|	Рег.Период КАК Дата,
	|	Рег.Function КАК КтоИзменял
	|ПОМЕСТИТЬ Function
	|ИЗ
	|	РегистрСведений.КК_ИнформацияФизЛицFunction КАК Рег
	|ГДЕ
	|  Рег.ФизЛицо В (ВЫБРАТЬ ФЛ.Ссылка ИЗ ФЛ КАК ФЛ)
	|;
	|ВЫБРАТЬ
	|   ""Вид деятельности"" КАК ТипИзменения,
	|	Рег.Период КАК Дата,
	|	Рег.ВидДеятельности КАК КтоИзменял
	|ПОМЕСТИТЬ ВидДеятельности
	|ИЗ
	|	РегистрСведений.КК_ИнформацияФизЛицВидДеятельности КАК Рег
	|ГДЕ
	|  Рег.ФизЛицо В (ВЫБРАТЬ ФЛ.Ссылка ИЗ ФЛ КАК ФЛ)
	|;
	
	|";
	
	Возврат ТекстЗапроса;
КонецФункции
// - АИГ Французова 21.02.2022 (Доработка)
// + АИГ Французова 21.02.2022 (Доработка)
Функция ПечатьИсториюИзменений(МассивОбъектов) Экспорт
	
	Макет = ПолучитьОбщийМакет("АИГ_Макет_ИсторияИзменений");
	ТабДокумент = Новый ТабличныйДокумент;
	ТабДокумент.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	ТабДокумент.ИмяПараметровПечати = "ПараметрыПечати_ИсторияИзменений";
	
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка1");
	ОбластьСтрокаТаблицы = Макет.ПолучитьОбласть("СтрокаТаблицы");
	ОбластьТипаИзменения  = Макет.ПолучитьОбласть("ИзменениеОбъекта");
	
	СтруктураПараметровПечати = Новый Структура;
	Запрос = Новый Запрос;
	Запрос.Текст = ВернутьТекстЗапроса(СтруктураПараметровПечати);
	Запрос.УстановитьПараметр("ТекущаяСсылка", МассивОбъектов[0].Ссылка);
	
	
	
	РезультатЗапроса = Запрос.ВыполнитьПакетСПромежуточнымиДанными();//Запрос.Выполнить().Выгрузить();
	к = 1;
	Пока к <  РезультатЗапроса.Количество() Цикл      
		РезультатТаблицы = РезультатЗапроса[к].Выгрузить();
		Если РезультатТаблицы.Количество()=0 Тогда
			к = к+1;
			Продолжить;
		КонецЕсли; 
		ЗаполнитьЗначенияСвойств(ОбластьТипаИзменения.Параметры,РезультатТаблицы[0]);    
		ТабДокумент.Вывести(ОбластьТипаИзменения);

		ТабДокумент.Вывести(ОбластьШапка);
				
		
		Для каждого стр из РезультатТаблицы Цикл
			СК = ОбщегоНазначения.СтрокаТаблицыЗначенийВСтруктуру(стр);
			ЗаполнитьЗначенияСвойств(ОбластьСтрокаТаблицы.Параметры,СК);
			ТабДокумент.Вывести(ОбластьСтрокаТаблицы);
		КонецЦикла;
		к = к+1;
	КонецЦикла;
	КорректировкаМасштабаТабДокумента(ТабДокумент, 70);
	Возврат ТабДокумент;  		
	
КонецФункции
// - АИГ Французова 21.02.2022 (Доработка)
// + АИГ Французова 21.02.2022 (Доработка)

Процедура  КорректировкаМасштабаТабДокумента(ТабДокумент,МинимальныйПроцентМасштаба=50) Экспорт
	
	Если ТипЗнч(ТабДокумент)<> Тип("ТабличныйДокумент") Тогда
		Возврат;
	КонецЕсли;
	
	//уменьшение масштаба для уменьшения количества страниц
	
	ИсходныйМасштаб = 100;
	
	ТабДокумент.МасштабПечати = 100;
	
	ИсходноеКоличествоСтраниц = ТабДокумент.КоличествоСтраниц();
	
	ТабДокумент.МасштабПечати = МинимальныйПроцентМасштаба;
	
	Если ТабДокумент.КоличествоСтраниц() Тогда
		
		КоличествоОптимизированныхСтраниц = ТабДокумент.КоличествоСтраниц();
		
		ТекущийПроцентМасштаба = МинимальныйПроцентМасштаба;
		
		Пока КоличествоОптимизированныхСтраниц=ТабДокумент.КоличествоСтраниц() Цикл
			
			ТекущийПроцентМасштаба = ТекущийПроцентМасштаба+1;
			
			ТабДокумент.МасштабПечати = ТекущийПроцентМасштаба;
			
			Если ТекущийПроцентМасштаба > ИсходныйМасштаб Тогда
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		ТабДокумент.МасштабПечати = ТабДокумент.МасштабПечати-10;
		
	Иначе //эффекта нет возвращаем мастаб печати обратно
		
		ТабДокумент.МасштабПечати = ИсходныйМасштаб;
		
		//увеличение масштаба для максимального заполнения страниц
		
		ТекущийПроцентМасштаба = ИсходныйМасштаб;
		
		Пока ИсходноеКоличествоСтраниц=ТабДокумент.КоличествоСтраниц() Цикл
			
			ТекущийПроцентМасштаба = ТекущийПроцентМасштаба+1;
			
			ТабДокумент.МасштабПечати = ТекущийПроцентМасштаба;
			
		КонецЦикла;
		
		ТабДокумент.МасштабПечати = ТабДокумент.МасштабПечати-1;
		
	КонецЕсли;
	
	
КонецПроцедуры
// - АИГ Французова 21.02.2022 (Доработка)
#КонецОбласти
